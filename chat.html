<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Israel Airways Chat</title>

  <style>
    html, body { height:100%; margin:0; background:#fff; }
    body { overflow:hidden; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

    /* Fallback overlay until chat is actually interactive */
    .boot {
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:12px;
      padding:18px;
      background:#fff;
      z-index:9999;
    }
    .boot.hidden { display:none; }

    .bootTitle { font-weight:900; font-size:16px; color:#08131F; text-align:center; }
    .bootSub { font-weight:700; font-size:12px; color:#6C7A8B; text-align:center; line-height:1.4; max-width:340px; }

    .bootBtn {
      border:none; border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(180deg,#0E8A5B,#0A6B46);
      color:#fff;
      width:min(340px, 92vw);
      font-size:14px;
    }

    /* Optional: if you still want to hide the internal home/header chrome,
       do it carefully (do NOT hide anything "launcher" related). */
    .hideChrome [class*="home" i],
    .hideChrome header[role="banner"],
    .hideChrome [role="banner"]{
      display:none !important;
    }
  </style>
</head>
<body>
  <div class="boot" id="boot">
    <div class="bootTitle">צ׳אט תמיכה • Israel Airways</div>
    <div class="bootSub">
      טוען את הצ׳אט… אם הוא לא נפתח מיד, לחץ/י על “התחל/י צ׳אט”.
      <br> (הסמל הקטן של Cognigy לא תמיד נטען בזמן — לכן אנחנו פותחים אוטומטית.)
    </div>
    <button class="bootBtn" id="bootStart">התחל/י צ׳אט</button>
  </div>

  <!-- IMPORTANT: pin a version instead of /latest/ to reduce random timing changes -->
  <!-- You can change v3.2.0 to whatever version you prefer -->
  <script src="https://github.com/Cognigy/Webchat/releases/download/v3.2.0/webchat.js"></script>

  <script>
    const ENDPOINT =
      "https://endpoint-trial.cognigy.ai/fa17d61a203862b03445bd139a8c2b3589dbd5e0325f8d84d917ddebbfef0bdc";

    const boot = document.getElementById("boot");
    const bootStart = document.getElementById("bootStart");

    // ---- helpers to detect if chat is actually open/usable ----
    function hasUsableInput(){
      const t = document.querySelector("textarea");
      if (t && t.offsetWidth > 0 && t.offsetHeight > 0) return true;

      const inp = document.querySelector("input[type='text']");
      if (inp && inp.offsetWidth > 0 && inp.offsetHeight > 0) return true;

      const ce = document.querySelector("[contenteditable='true']");
      if (ce && ce.offsetWidth > 0 && ce.offsetHeight > 0) return true;

      return false;
    }

    function hideBootIfReady(){
      if (hasUsableInput()){
        boot.classList.add("hidden");
        // Optional: try to hide chrome once chat is open
        document.documentElement.classList.add("hideChrome");
        return true;
      }
      return false;
    }

    // ---- Try to click the Cognigy launcher if it exists ----
    function clickLauncherIfPresent(){
      // common patterns across versions:
      const launcher =
        document.querySelector("[data-testid*='launcher' i]") ||
        document.querySelector("[aria-label*='open' i][role='button']") ||
        document.querySelector("button[aria-label*='open' i]") ||
        document.querySelector("button[class*='launcher' i]") ||
        document.querySelector("[class*='launcher' i] button");

      if (launcher && launcher.offsetWidth > 0 && launcher.offsetHeight > 0){
        launcher.click();
        return true;
      }
      return false;
    }

    // ---- Try to click “Start conversation” if that screen is shown ----
    function clickStartConversationIfPresent(){
      const labels = [
        "Start conversation",
        "Start Conversation",
        "התחל שיחה",
        "התחל/י שיחה",
        "התחל",
        "Start"
      ];

      const btns = Array.from(document.querySelectorAll("button"));
      for (const b of btns){
        const txt = (b.innerText || "").trim();
        if (!txt) continue;
        if (labels.some(l => txt.toLowerCase() === l.toLowerCase() || txt.toLowerCase().includes(l.toLowerCase()))){
          if (b.offsetWidth > 0 && b.offsetHeight > 0){
            b.click();
            return true;
          }
        }
      }
      return false;
    }

    // ---- One “attempt cycle” ----
    function attemptOpen(){
      // 1) if already usable, hide boot and stop
      if (hideBootIfReady()) return true;

      // 2) try to open widget
      const didLauncher = clickLauncherIfPresent();

      // 3) try start conversation
      const didStart = clickStartConversationIfPresent();

      // 4) check again
      hideBootIfReady();

      return didLauncher || didStart;
    }

    // Manual fallback button
    bootStart.addEventListener("click", () => {
      // run several quick attempts
      let i = 0;
      const t = setInterval(() => {
        i++;
        attemptOpen();
        if (hasUsableInput() || i >= 25) clearInterval(t);
      }, 200);
    });

    // Init webchat (with v3 settings structure supported by hosted script)
    try{
      initWebchat(ENDPOINT, {
        settings: {
          embeddingConfiguration: {
            awaitEndpointConfig: true
          }
        }
      });
    } catch (e){
      console.error("initWebchat failed:", e);
    }

    // Aggressive but safe retry loop for the first few seconds
    let tries = 0;
    const retry = setInterval(() => {
      tries++;
      attemptOpen();
      if (hasUsableInput() || tries >= 60) clearInterval(retry);
    }, 150);

    // Also react to late DOM rendering
    const obs = new MutationObserver(() => {
      attemptOpen();
      if (hasUsableInput()) obs.disconnect();
    });
    obs.observe(document.documentElement, { childList:true, subtree:true });
  </script>
</body>
</html>
